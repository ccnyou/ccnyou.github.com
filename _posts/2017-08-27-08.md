---
layout: post
title: 【原创】手Q讨论组问题定位日志
---
{% capture base_image_path %}{{ site.url }}/images{{ page.id }}{% endcapture %}

前几天老大反馈讨论组除了问题，用户资料丢失，很严重。在不多干扰老板的情况下，通过日志和代码对问题进行了定位和现场还原，记录如下。

1，收到RTX消息，老大反馈手Q和电脑QQ都找不到讨论组。  

2，根据18，19点的日志搜索目标群信息，确认服务端有下发。  

3，怀疑是服务端下发后客户端某些标志位出错了，导致两个客户端都过滤了显示。

4，确认客户端代码过滤逻辑，仅过滤群成员memNum==0的群，从日志看没有符合条件的群，排除。

5，找后台对flag，补充了flag日志，但事情没有实质进展。

6，找之前负责讨论组的同事对讨论组逻辑，找老大当面确认问题，当时老大从两端都能搜到讨论组了。  
提出新的假设：可能某一时刻服务端没有返回这个讨论组，导致客户端删除了本地的讨论组。
	
7，从日志确认，所有的请求回包都有这个讨论组，假设被否定。

8，PC客户端根据日志分析，这个是他们版本的搜索策略bug。

9，从本地代码分析，可以确认目标讨论组是在本地存在而且一直都是跟服务器一致的。由于老大中间更新过版本，提出新的假设：  
a，本地数据库bug；  
b，手Q客户端版本bug；  
c，日志不对，但不对也还有两个可能：  
&emsp;&emsp;c1) 我们抓了老大非问题版本的日志（老大同事会装几个版本的手Q）；  
&emsp;&emsp;c2) 我们抓对了版本，但是时间不对；  
* 首先排除a，如果数据库bug，也会导致产生讨论组同步的的请求，这个请求有详细日志，而日志没有看到目标讨论组的同步信息。  
* 通过对比code review，基本可以排除b，中间版本基本没有动到讨论组逻辑。
* 基本确认是c，但是实际c有两个可能：

10，老大在群上发话，说发现异常是在18点之前，确认了可能c2。我们赶紧取了16-17点日志。

11，从日志分析，老大搜索关键字多了一个空格。在客户端测试，多一个空格确实搜不出来。

12，找负责搜索的同事确认，这个是客户端讨论组搜索的bug。


PS，后面在leader指导下，整理了个精简版：

周四下午老大反馈找不到讨论组，在手Q和PC客户端都找不到。

结论是是两个客户端都有bug。手Q的问题定位过程如下。

根据掌握的信息我们提出了以下的假设：  
* 服务器数据不对；  
* 本地数据库bug；  
* 手Q客户端版本bug；  
&emsp;&emsp;- 可能是flag无效被客户端过滤了  
&emsp;&emsp;- 可能是主干合流引入的bug
	
* 日志不对；  
&emsp;&emsp;- 老大装了几个手Q，可能抓错日志
&emsp;&emsp;- 抓的日志时间不对
	
通过分析日志和主干代码，借助CodeReview工具，逐个排除了错误的假设。

最终通过抓取更早的日志，拿到关键日志信息，跟负责搜索的同事确认这个是讨论组搜索的bug。

